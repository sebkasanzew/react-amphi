name: Release CLI

on:
  push:
    branches: [main]
    paths:
      - 'apps/cli/**'
      - 'packages/shared/**'
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: release-cli-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build-cli:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: amphi-linux
            extension: ''
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: amphi-macos-arm64
            extension: ''
          - os: macos-13
            target: bun-darwin-x64
            artifact: amphi-macos-x64
            extension: ''
          - os: windows-latest
            target: bun-windows-x64
            artifact: amphi-windows
            extension: '.exe'

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate ASCII art
        run: bun run --filter @amphi/shared generate:ascii

      - name: Build CLI executable
        working-directory: apps/cli
        run: bun build source/cli.tsx --compile --target=${{ matrix.target }} --outfile dist/${{ matrix.artifact }}${{ matrix.extension }} --conditions=production

      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ matrix.artifact }}
          path: apps/cli/dist/${{ matrix.artifact }}${{ matrix.extension }}
          retention-days: 30

  release:
    name: Create Release Assets
    needs: build-cli
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: artifacts

      - name: Create checksums
        run: |
          cd artifacts
          for dir in */; do
            cd "$dir"
            for file in *; do
              sha256sum "$file" > "$file.sha256"
            done
            cd ..
          done

      - name: Upload release assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            artifacts/amphi-linux/*
            artifacts/amphi-macos-arm64/*
            artifacts/amphi-macos-x64/*
            artifacts/amphi-windows/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
